dependencies:
  pre:
    - echo "//npmregistry.density.rodeo/:_authToken=${PRIVATE_NPM_TOKEN}" >> ~/.npmrc

test:
  override:
    - /bin/true
  post:
    - |
      # Publish all charts once on master
      # if [ "$CIRCLE_BRANCH" == "master" ]; then
      if [ "$CIRCLE_BRANCH" == "auto-build-storybook" ]; then

        git clone git@github.com:densityco/charts.git master_charts/

        echo "Publishing all charts..."
        for chart in $(find charts/ -maxdepth 1 -mindepth 1 -type d -printf "%f\n"); do
          if [ "$chart" == "template" -o "$chart" == "dist" ]; then # This isn't a chart, but a template for `./make-chart`
            continue
          fi

          if [ \
            "$(cat charts/$chart/package.json | jq .version)" != \
            "$(cat master_charts/charts/$chart/package.json | jq .version)" \
          ]; then
            echo "$(cat charts/$chart/package.json | jq .version)" 
            echo
            echo "================"
            echo " $chart"
            echo "================"
            make publish CHART=$chart
          else
            echo "Chart $chart is up to date."
          fi
        done

        # Finally, try to publish the main package
        echo
        echo
        echo "================"
        echo " @density/charts"
        echo "================"
        npm publish .
      else
        echo "Packages are only published to npm on branch 'master'."
      fi
      exit 0
